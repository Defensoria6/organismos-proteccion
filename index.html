<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Organismos de Protección — Directorio</title>
  <style>
    body {font-family: sans-serif; margin:0; padding:0; background:#f4f4f4;}
    .app{max-width:1100px;margin:auto;background:#fff;border-radius:10px;padding:10px;}
    .header{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#2c3e50;color:#fff;}
    .btn{padding:6px 12px;border:none;border-radius:4px;cursor:pointer;background:#667eea;color:#fff;}
    .btn.ghost{background:#ccc;color:#000;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:8px;border-bottom:1px solid #ddd;}
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;}
    .modal.show{display:flex;}
    .modal-card{background:#fff;padding:20px;border-radius:8px;width:90%;max-width:500px;}
    .form-group{margin-bottom:10px;}
    input,select,textarea{width:100%;padding:6px;}
    .empty-state{padding:20px;text-align:center;font-weight:bold;color:#fff;background:#667eea;border-radius:6px;}
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div><h2>Organismos de Protección</h2></div>
      <div>
        <button class="btn" onclick="openModal('add')">Nuevo</button>
        <button class="btn ghost" onclick="printList()">Imprimir</button>
      </div>
    </header>
    <section class="controls">
      <input id="searchInput" type="search" placeholder="Buscar..." oninput="filterOrganisms()" style="width:100%;padding:6px;margin:10px 0;">
    </section>
    <main>
      <table>
        <thead><tr><th>Nombre</th><th>Tipo</th><th>Email</th><th>Teléfono</th><th>Contacto</th><th>Acciones</th></tr></thead>
        <tbody id="organismsTableBody"></tbody>
      </table>
    </main>
  </div>
  <div id="organismModal" class="modal">
    <div class="modal-card">
      <h3 id="modalTitle">Agregar Organismo</h3>
      <form id="organismForm" onsubmit="event.preventDefault(); saveOrganism();">
        <div class="form-group"><label>Nombre*</label><input id="nombre" required></div>
        <div class="form-group"><label>Tipo*</label><select id="tipo" required>
          <option value="">Seleccionar...</option><option>Hospital</option><option>Ministerio</option><option>Centro Asistencial</option>
          <option>Unidad de Traslado</option><option>Dirección Gubernamental</option><option>Fundación</option><option>Otro</option></select></div>
        <div class="form-group"><label>Email</label><input id="email" type="email"></div>
        <div class="form-group"><label>Teléfono</label><input id="telefono"></div>
        <div class="form-group"><label>Contacto</label><input id="contacto"></div>
        <div class="form-group"><label>Notas</label><textarea id="notas"></textarea></div>
        <div><button type="button" class="btn ghost" onclick="closeModal()">Cancelar</button> <button type="submit" class="btn">Guardar</button></div>
      </form>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCpPdY984mCYWQodeqA6ZVXFxedalExc34",
      authDomain: "repositorio-documentos.firebaseapp.com",
      databaseURL: "https://repositorio-documentos-default-rtdb.firebaseio.com",
      projectId: "repositorio-documentos",
      storageBucket: "repositorio-documentos.firebasestorage.app",
      messagingSenderId: "359488594361",
      appId: "1:359488594361:web:421264bbc3c5f8f7c01668"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const organismsRef = db.ref('organismos');
    let editingId = null;

    // Organismos originales
    const initialOrganisms = [
      {nombre:"Hospital Barreyro",tipo:"Hospital",email:"hospitaldepediatriabarreyro@gmail.com",telefono:"",contacto:"",notas:""},
      {nombre:"Hospital Carrillo",tipo:"Hospital",email:"hospitalsaludmentalcarrillo@gmail.com",telefono:"",contacto:"",notas:""},
      {nombre:"Ministerio de Salud Pública de Misiones",tipo:"Ministerio",email:"juridicomspmisiones@gmail.com",telefono:"",contacto:"",notas:"Para compartir oficios dirigidos a cualquier Hospital"},
      {nombre:"Centro Asistencial",tipo:"Centro Asistencial",email:"",telefono:"+5493755636878",contacto:"Jordana Duarte Martinelli",notas:"Encargada de recibir oficios"},
      {nombre:"Unidad Central de Traslado",tipo:"Unidad de Traslado",email:"mps-uct@hotmail.com",telefono:"",contacto:"",notas:""},
      {nombre:"Dirección de Asuntos de Familia",tipo:"Dirección Gubernamental",email:"",telefono:"+5493764856048",contacto:"",notas:""},
      {nombre:"Fundación Reto a la vida",tipo:"Fundación",email:"retomisiones@gmail.com",telefono:"",contacto:"",notas:""}
    ];

    // Precarga si DB está vacía
    organismsRef.once('value', snap => {
      if(!snap.exists()){
        initialOrganisms.forEach(o=>organismsRef.push(o));
      }
    });

    function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

    organismsRef.on('value', snap => {
      const data = snap.val()||{};
      const list = Object.entries(data).map(([id,v])=>({id,...v}));
      renderTable(list);
    });

    function renderTable(list){
      const tbody=document.getElementById('organismsTableBody');tbody.innerHTML='';
      if(list.length===0){tbody.innerHTML=`<tr><td colspan="6" class="empty-state">No hay organismos registrados</td></tr>`;return;}
      list.forEach(o=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${escapeHtml(o.nombre)}</td><td>${escapeHtml(o.tipo)}</td><td>${escapeHtml(o.email||'-')}</td>
        <td>${escapeHtml(o.telefono||'-')}</td><td>${escapeHtml(o.contacto||'-')}</td>
        <td><button class='btn ghost' onclick='editOrganism("${o.id}",${JSON.stringify(o)})'>Editar</button>
        <button class='btn' style='background:#ff4b2b' onclick='deleteOrganism("${o.id}")'>Eliminar</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function openModal(mode,id=null,data=null){
      document.getElementById('organismForm').reset();
      editingId=null;
      document.getElementById('modalTitle').textContent=mode==='edit'?'Editar Organismo':'Agregar Organismo';
      if(mode==='edit'&&data){
        document.getElementById('nombre').value=data.nombre;
        document.getElementById('tipo').value=data.tipo;
        document.getElementById('email').value=data.email;
        document.getElementById('telefono').value=data.telefono;
        document.getElementById('contacto').value=data.contacto;
        document.getElementById('notas').value=data.notas;
        editingId=id;
      }
      document.getElementById('organismModal').classList.add('show');
    }
    function closeModal(){document.getElementById('organismModal').classList.remove('show');editingId=null;}

    function saveOrganism(){
      const data={nombre:document.getElementById('nombre').value.trim(),
        tipo:document.getElementById('tipo').value.trim(),
        email:document.getElementById('email').value.trim(),
        telefono:document.getElementById('telefono').value.trim(),
        contacto:document.getElementById('contacto').value.trim(),
        notas:document.getElementById('notas').value.trim()};
      if(!data.nombre||!data.tipo){alert('Completa nombre y tipo');return;}
      if(editingId){organismsRef.child(editingId).update(data);}else{organismsRef.push(data);}
      closeModal();
    }

    function editOrganism(id,data){openModal('edit',id,data);}
    function deleteOrganism(id){if(confirm('¿Eliminar?'))organismsRef.child(id).remove();}
    function filterOrganisms(){
      const q=document.getElementById('searchInput').value.toLowerCase();
      organismsRef.once('value',snap=>{
        const all=snap.val()||{};
        const filtered=Object.entries(all).map(([id,v])=>({id,...v})).filter(o=>o.nombre.toLowerCase().includes(q)||o.tipo.toLowerCase().includes(q));
        renderTable(filtered);
      });
    }
    function printList(){window.print();}
  </script>
</body>
</html>
